<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transition Builder | Hudl TV Support Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #f97316; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; }
        .tool-card { background: var(--card); border: 1px solid var(--border); border-radius: 1rem; padding: 2.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem; color: #94a3b8; }
        input, select { width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid var(--border); border-radius: 0.5rem; color: white; }
        #generateBtn { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 0.5rem; font-weight: 800; cursor: pointer; width: 100%; margin-top: 1rem; }
        #status { margin-top: 1rem; text-align: center; font-weight: 600; color: var(--primary); }
        /* Debug Console Styles */
        #debugConsole { background: #000; color: #0f0; font-family: 'Courier New', monospace; font-size: 0.75rem; padding: 1rem; border-radius: 0.5rem; margin-top: 2rem; height: 150px; overflow-y: auto; border: 1px solid #334155; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transition Builder</h1>
        <div class="tool-card">
            <div class="form-group">
                <label>School Name</label>
                <input type="text" id="schoolName" placeholder="e.g., Bear">
            </div>
            <div class="form-group">
                <label>Cut Delay Frame</label>
                <input type="number" id="cutDelayFrame" value="15">
            </div>
            <div class="form-group">
                <label>Transparency Mode</label>
                <select id="chromaKey">
                    <option value="none">Detect Existing Alpha (ProRes 4444)</option>
                    <option value="colorkey=0x000000:0.1:0.1">Force Remove Black</option>
                    <option value="colorkey=0x00FF00:0.1:0.1">Force Remove Green</option>
                </select>
            </div>
            <div class="form-group">
                <label>Upload Video</label>
                <input type="file" id="videoFile">
            </div>
            <button id="generateBtn" onclick="processTransition()">BUILD PACKAGE</button>
            <div id="status">Ready</div>
            <div id="debugConsole">DEBUG LOG:<br></div>
        </div>
    </div>

<script>
    <script src="coi-serviceworker.js"></script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    
    // Pipe FFmpeg logs to our on-screen console
    ffmpeg.setLogger(({ type, message }) => {
        const consoleEl = document.getElementById('debugConsole');
        consoleEl.innerHTML += `[${type}] ${message}<br>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
    });

    async function processTransition() {
        const btn = document.getElementById('generateBtn');
        const status = document.getElementById('status');
        const chromaKey = document.getElementById('chromaKey').value;
        const videoInput = document.getElementById('videoFile').files[0];
        
        if (!videoInput) return alert("Select a file.");
        btn.disabled = true;

        try {
            status.innerText = "Loading FFmpeg...";
            if (!ffmpeg.isLoaded()) await ffmpeg.load();

            ffmpeg.FS('writeFile', 'input', await fetchFile(videoInput));
            
            status.innerText = "Extracting Frames...";
            let filter = 'scale=-1:720,fps=30';
            if (chromaKey !== 'none') filter = `${chromaKey},${filter}`;

            // We use -pix_fmt rgba to ensure the output sequence MUST have an alpha channel
            await ffmpeg.run('-i', 'input', '-vf', filter, '-pix_fmt', 'rgba', 'images/%d.png');

            const files = ffmpeg.FS('readdir', 'images').filter(f => f.endsWith('.png'));
            if (files.length === 0) throw new Error("No frames generated. Check video format.");

            status.innerText = `Zipping ${files.length} frames...`;
            const zip = new JSZip();
            const imgFolder = zip.folder("images");
            for (const f of files) {
                imgFolder.file(f, ffmpeg.FS('readFile', `images/${f}`));
            }

            // Minimalist overlay.html to verify functionality
            zip.file("overlay.html", `<html><body style="background:transparent;"><script>function play(){ /* automated */ }<\/script></body></html>`);
            zip.file("position.json", JSON.stringify({width:1280, height:720}));

            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "custom_transition.ptt";
            a.click();
            status.innerText = "Done!";
        } catch (e) {
            status.innerText = "Error! See Debug Log below.";
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
