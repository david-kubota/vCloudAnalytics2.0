<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transition Builder | Hudl TV Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #f97316; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; }
        .tool-card { background: var(--card); border: 1px solid var(--border); border-radius: 1rem; padding: 2.5rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 0.5rem; color: #94a3b8; }
        input, select { width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid var(--border); border-radius: 0.5rem; color: white; }
        #generateBtn { background: var(--primary); color: white; border: none; padding: 1.25rem; border-radius: 0.5rem; font-weight: 800; cursor: pointer; width: 100%; margin-top: 1rem; }
        #generateBtn:disabled { background: #475569; }
        #status { margin-top: 1.5rem; text-align: center; font-weight: 600; color: var(--primary); }
        #progressBarContainer { width: 100%; background: #0f172a; height: 10px; border-radius: 5px; margin: 1rem 0; display: none; overflow: hidden; }
        #progressBar { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }
        #debugConsole { background: #000; color: #0f0; font-family: monospace; font-size: 0.7rem; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem; height: 120px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color:white; text-align:center;">Transition Builder</h1>
        <div class="tool-card">
            <div class="form-group">
                <label>School Name</label>
                <input type="text" id="schoolName" placeholder="e.g., Bear">
            </div>
            <div class="form-group">
                <label>Cut Delay Frame (out of 30)</label>
                <input type="number" id="cutDelayFrame" value="15">
            </div>
            <div class="form-group">
                <label>Force Transparency Mode</label>
                <select id="chromaKey">
                    <option value="none">Detect Existing Alpha Channel</option>
                    <option value="colorkey=0x000000:0.1:0.1">Remove Solid Black (#000000)</option>
                    <option value="colorkey=0x00FF00:0.1:0.1">Remove Solid Green (#00FF00)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Upload Video</label>
                <input type="file" id="videoFile" accept="video/mp4,video/quicktime">
            </div>
            <div id="progressBarContainer"><div id="progressBar"></div></div>
            <button id="generateBtn" onclick="processTransition()">GENERATE .PTT PACKAGE</button>
            <div id="status">Ready</div>
            <div id="debugConsole">SYSTEM LOG: Awaiting upload...</div>
        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // This specific URL is the key to bypassing the "Loading Loop" on GitHub
        const ffmpeg = createFFmpeg({ 
            log: true,
            corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
        });

        ffmpeg.setLogger(({ message }) => {
            const log = document.getElementById('debugConsole');
            log.innerText += `\n${message}`;
            log.scrollTop = log.scrollHeight;
        });

        ffmpeg.setProgress(({ ratio }) => {
            document.getElementById('progressBar').style.width = (ratio * 100) + '%';
        });

        async function processTransition() {
            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            const video = document.getElementById('videoFile').files[0];
            const school = document.getElementById('schoolName').value || "Transition";
            const cutFrame = document.getElementById('cutDelayFrame').value;
            const chroma = document.getElementById('chromaKey').value;

            if (!video) return alert("Please select a video file.");
            btn.disabled = true;
            document.getElementById('progressBarContainer').style.display = 'block';

            try {
                if (!ffmpeg.isLoaded()) {
                    status.innerText = "Connecting to Engine...";
                    await ffmpeg.load();
                }

                status.innerText = "Extracting PNG Sequence...";
                ffmpeg.FS('writeFile', 'input', await fetchFile(video));
                
                let filter = 'scale=-1:720,fps=30';
                if (chroma !== 'none') filter = `${chroma},${filter}`;

                // Process the video and extract the 720p PNG sequence [cite: 351, 353]
                await ffmpeg.run('-i', 'input', '-vf', filter, '-pix_fmt', 'rgba', 'out_%d.png');

                const files = ffmpeg.FS('readdir', '.').filter(f => f.startsWith('out_') && f.endsWith('.png'));
                
                status.innerText = "Building .ptt Package...";
                const zip = new JSZip();
                const imgFolder = zip.folder("images");
                files.forEach((f, i) => {
                    imgFolder.file(`${i + 1}.png`, ffmpeg.FS('readFile', f));
                });

                // Generate mandatory variables for Production Truck 
                const delay = (cutFrame / 30).toFixed(2);
                const html = `<html><body style="background:transparent;"><script>var transitionName="${school} TRANSITION"; var transitionAbbreviatedName="${school}"; var transitionCutDelay=${delay};<\/script></body></html>`;
                
                zip.file("overlay.html", html);
                zip.file("position.json", JSON.stringify({width:1280, height:720}));

                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = `${school}.ptt`;
                a.click();
                status.innerText = "Complete! File Downloaded.";
            } catch (e) {
                status.innerText = "Process Failed. See Log.";
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
